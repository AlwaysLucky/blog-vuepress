---
title: vue-router源码实现
date: 2023-05-10
tags:
  - vue
summary: vue-router
---

### 分析
* vue-router是一个插件
  * 实现VueRouter类
    1. 处理路由选项
    2. 监听url变化，`hashchange`事件
    3. 响应这个变化
  * 实现install
    1. 挂载$router
    2. 注册router-view，router-link

### 创建VueRouter类
```js
// VueRouter.js
import Link from './RouterLink'
import View from './RouterView'

let Vue

class VueRouter{
  constructor(options) {
    this.$options = options
    
    const initial = location.hash.slice(1) || '/'
    /*
      使current变成一个响应式对象（触发router-view更新）
      这里不能使用Vue.set(this, 'current', initial)；因为Vue.set()第一个参数必须是响应式对象
    */
    Vue.util.defineReactive(this, 'current', initial)
    window.addEventListener('hashchange', this.onHashChange.bind(this))
  }

  onHashChange() {
    this.current = location.hash.slice(1)
  }
}

// Vue.use时传入Vue
VueRouter.install = function(_Vue){
  Vue = _Vue
  Vue.mixin({
    beforeCreate() {
      // 只有根组件才有router
      if (this.$options.router) {
        Vue.prototype.$router = this.$options.router // 全局挂在$router
      }
    }
  })

  Vue.component('router-link', Link)
  Vue.component('router-view', View)
}

export default VueRouter
```
```js
// RouterLink.js
export default {
  props: {
    to: {
      type: String,
      required: true
    }
  },

  render(h) {
    return h('a', {
      attrs: {
        href: '#' + this.to
      }
    }, [this.$slots.default])
  }
}
```

```js
// RouterView.js
export default {
  render(h) {
    let component = null
    const { $options, current } = this.$router
    const route = $options.routes.find(route => route.path === current)
    
    route && (component = route.component)
    return h(component)
  }
}
```

### 使用
```js
import Vue from 'vue/dist/vue.esm'
import VueRouter from './vue/vueRouter/VueRouter'

Vue.use(VueRouter)

const router = new VueRouter({
  routes: [
    {
      name: 'hello',
      path: '/hello',
      component: () => import('./vue/vueRouter/Hello')
    }
  ]
})

new Vue({
  el: '#app',
  router
})
```